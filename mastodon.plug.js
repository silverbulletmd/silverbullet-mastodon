var mod=(()=>{var L=Object.defineProperty;var De=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var $e=Object.prototype.hasOwnProperty;var C=(e,t)=>{for(var r in t)L(e,r,{get:t[r],enumerable:!0})},ze=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ne(t))!$e.call(e,o)&&o!==r&&L(e,o,{get:()=>t[o],enumerable:!(n=De(t,o))||n.enumerable});return e};var qe=e=>ze(L({},"__esModule",{value:!0}),e);var Hr={};C(Hr,{functionMapping:()=>Fe});function ne(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function U(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function Le(e,t){return typeof e!="string"&&(t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:e.body?U(new Uint8Array(await new Response(e.body).arrayBuffer())):void 0},e=e.url),syscall("sandboxFetch.fetch",e,t)}function oe(){globalThis.nativeFetch=globalThis.fetch,globalThis.fetch=async function(e,t){let r=await Le(e,t&&{method:t.method,headers:t.headers,base64Body:t.body?U(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0});return new Response(r.base64Body?ne(r.base64Body):null,{status:r.status,headers:r.headers})}}typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var B=new Map,W=0;function I(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((r,n)=>{W++,B.set(W,{resolve:r,reject:n}),I({type:"sys",id:W,name:e,args:t})});function se(e,t){self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));I({type:"invr",id:n.id,result:s})}catch(s){console.error(s),I({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=B.get(o);if(!s)throw Error("Invalid request id");B.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),I({type:"manifest",manifest:t})}oe();var x={};C(x,{confirm:()=>lt,dispatch:()=>ct,downloadFile:()=>Xe,filterBox:()=>tt,flashNotification:()=>et,fold:()=>mt,foldAll:()=>gt,getCurrentPage:()=>Ue,getCursor:()=>Ge,getSelection:()=>Ye,getText:()=>Be,getUiOption:()=>ft,hidePanel:()=>nt,insertAtCursor:()=>at,insertAtPos:()=>ot,moveCursor:()=>it,navigate:()=>Qe,openUrl:()=>Ze,prompt:()=>ut,reloadPage:()=>Je,reloadUI:()=>Ke,replaceRange:()=>st,save:()=>Ve,setPage:()=>We,setSelection:()=>He,setUiOption:()=>pt,showPanel:()=>rt,toggleFold:()=>yt,unfold:()=>ht,unfoldAll:()=>vt,vimEx:()=>dt});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var a=self.syscall;function Ue(){return a("editor.getCurrentPage")}function We(e){return a("editor.setPage",e)}function Be(){return a("editor.getText")}function Ge(){return a("editor.getCursor")}function Ye(){return a("editor.getSelection")}function He(e,t){return a("editor.setSelection",e,t)}function Ve(){return a("editor.save")}function Qe(e,t,r=!1,n=!1){return a("editor.navigate",e,t,r,n)}function Je(){return a("editor.reloadPage")}function Ke(){return a("editor.reloadUI")}function Ze(e,t=!1){return a("editor.openUrl",e,t)}function Xe(e,t){return a("editor.downloadFile",e,t)}function et(e,t="info"){return a("editor.flashNotification",e,t)}function tt(e,t,r="",n=""){return a("editor.filterBox",e,t,r,n)}function rt(e,t,r,n=""){return a("editor.showPanel",e,t,r,n)}function nt(e){return a("editor.hidePanel",e)}function ot(e,t){return a("editor.insertAtPos",e,t)}function st(e,t,r){return a("editor.replaceRange",e,t,r)}function it(e,t=!1){return a("editor.moveCursor",e,t)}function at(e){return a("editor.insertAtCursor",e)}function ct(e){return a("editor.dispatch",e)}function ut(e,t=""){return a("editor.prompt",e,t)}function lt(e){return a("editor.confirm",e)}function ft(e){return a("editor.getUiOption",e)}function pt(e,t){return a("editor.setUiOption",e,t)}function dt(e){return a("editor.vimEx",e)}function mt(){return a("editor.fold")}function ht(){return a("editor.unfold")}function yt(){return a("editor.toggleFold")}function gt(){return a("editor.foldAll")}function vt(){return a("editor.unfoldAll")}var _={};C(_,{parseMarkdown:()=>bt});function bt(e){return a("markdown.parseMarkdown",e)}var w={};C(w,{deleteAttachment:()=>kt,deleteFile:()=>Dt,deletePage:()=>Ot,getAttachmentMeta:()=>jt,getFileMeta:()=>Rt,getPageMeta:()=>Pt,listAttachments:()=>At,listFiles:()=>Mt,listPages:()=>xt,listPlugs:()=>St,readAttachment:()=>Et,readFile:()=>It,readPage:()=>_t,writeAttachment:()=>Ct,writeFile:()=>Ft,writePage:()=>Tt});function xt(e=!1){return a("space.listPages",e)}function Pt(e){return a("space.getPageMeta",e)}function _t(e){return a("space.readPage",e)}function Tt(e,t){return a("space.writePage",e,t)}function Ot(e){return a("space.deletePage",e)}function St(){return a("space.listPlugs")}function At(){return a("space.listAttachments")}function jt(e){return a("space.getAttachmentMeta",e)}function Et(e){return a("space.readAttachment",e)}function Ct(e,t){return a("space.writeAttachment",e,t)}function kt(e){return a("space.deleteAttachment",e)}function Mt(){return a("space.listFiles")}function It(e){return a("space.readFile",e)}function Rt(e){return a("space.getFileMeta",e)}function Ft(e,t){return a("space.writeFile",e,t)}function Dt(e){return a("space.deleteFile",e)}function G(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,G(t)}}function Y(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...Y(n,t)];return r}async function ie(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await ie(n,t)];return r}async function H(e,t){if(e.children){let r=e.children.slice();for(let n of r){let o=await t(n);if(o!==void 0){let s=e.children.indexOf(n);o?e.children.splice(s,1,o):e.children.splice(s,1)}else await H(n,t)}}}function S(e,t){return Y(e,r=>r.type===t)[0]}function ae(e,t){Y(e,t)}async function ce(e,t){await ie(e,t)}function A(e){let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(A(r));return t.join("")}var P=globalThis.syscall;var g={};C(g,{parse:()=>Gt,stringify:()=>Yt});function Gt(e){return P("yaml.parse",e)}function Yt(e){return P("yaml.stringify",e)}async function Vt(e,t){let r=await w.readPage(e),n=await _.parseMarkdown(r),o;return ae(n,s=>{if(s.type!=="FencedCode")return!1;let i=S(s,"CodeInfo");if(t&&!i||t&&!t.includes(i.children[0].text))return!1;let c=S(s,"CodeText");return c?(o=c.children[0].text,!0):!1}),o}async function R(e,t=["yaml"]){let r=await Vt(e,t);if(r!==void 0)try{return g.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}var Qt="SETTINGS";async function F(e,t){try{let n=(await R(Qt,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}async function ue(e){try{let r=(await R("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}async function le(e,t=[],r=!1){let n={};return G(e),await H(e,async o=>{if(o.type==="Hashtag"){if(o.parent&&o.parent.type==="Paragraph"){let u=o.children[0].text.substring(1);n.tags||(n.tags=[]),Array.isArray(n.tags)&&!n.tags.includes(u)&&n.tags.push(u)}return}if(o.type==="FrontMatter"){let u=o.children[1].children[0],f=A(u);try{let d=await g.parse(f),v={...d};if(n={...n,...d},t.length>0){let O=!1;for(let M of t)M in v&&(delete v[M],O=!0);O&&(u.text=await g.stringify(v))}if(Object.keys(v).length===0||r)return null}catch(d){console.warn("Could not parse frontmatter",d.message)}}if(o.type!=="FencedCode")return;let s=S(o,"CodeInfo");if(!s||s.children[0].text!=="meta")return;let i=S(o,"CodeText");if(!i)return;let c=i.children[0].text,l=g.parse(c),p={...l};if(n={...n,...l},t.length>0){let u=!1;for(let f of t)f in p&&(delete p[f],u=!0);u&&(i.children[0].text=(await g.stringify(p)).trim())}if(Object.keys(p).length===0)return null}),n.name&&(n.displayName=n.name,delete n.name),n}async function fe(e,t){let r=null;return await ce(e,async n=>{if(n.type==="FrontMatter"){let o=n.children[1].children[0],s=A(o);try{let c={...await g.parse(s),...t};r={changes:{from:o.from,to:o.to,insert:await g.stringify(c)}}}catch(i){console.error("Error parsing YAML",i)}return!0}return!1}),r||(r={changes:{from:0,to:0,insert:`---
`+await g.stringify(t)+`---
`}}),r}function Jt(e,t){var r=Object.setPrototypeOf;r?r(e,t):e.__proto__=t}function Kt(e,t){t===void 0&&(t=e.constructor);var r=Error.captureStackTrace;r&&r(e,t)}var Zt=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,o){n.__proto__=o}||function(n,o){for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(n[s]=o[s])},e(t,r)};return function(t,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}(),j=function(e){Zt(t,e);function t(r,n){var o=this.constructor,s=e.call(this,r,n)||this;return Object.defineProperty(s,"name",{value:o.name,enumerable:!1,configurable:!0}),Jt(s,o.prototype),Kt(s),s}return t}(Error);var h=function(){return h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},h.apply(this,arguments)};function pe(e){return e.toLowerCase()}var Xt=[/([a-z0-9])([A-Z])/g,/([A-Z])([A-Z][a-z])/g],er=/[^A-Z0-9]+/gi;function T(e,t){t===void 0&&(t={});for(var r=t.splitRegexp,n=r===void 0?Xt:r,o=t.stripRegexp,s=o===void 0?er:o,i=t.transform,c=i===void 0?pe:i,l=t.delimiter,p=l===void 0?" ":l,u=de(de(e,n,"$1\0$2"),s,"\0"),f=0,d=u.length;u.charAt(f)==="\0";)f++;for(;u.charAt(d-1)==="\0";)d--;return u.slice(f,d).split("\0").map(c).join(p)}function de(e,t,r){return t instanceof RegExp?e.replace(t,r):t.reduce(function(n,o){return n.replace(o,r)},e)}function V(e,t){var r=e.charAt(0),n=e.substr(1).toLowerCase();return t>0&&r>="0"&&r<="9"?"_"+r+n:""+r.toUpperCase()+n}function me(e,t){return t===void 0&&(t={}),T(e,h({delimiter:"",transform:V},t))}function tr(e,t){return t===0?e.toLowerCase():V(e,t)}function he(e,t){return t===void 0&&(t={}),me(e,h({transform:tr},t))}function D(e,t){return t===void 0&&(t={}),T(e,h({delimiter:"."},t))}var N=function(){return N=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},N.apply(this,arguments)};function $(e,t){return t===void 0&&(t={}),D(e,N({delimiter:"_"},t))}var nr=Object.create,J=Object.defineProperty,or=Object.getOwnPropertyDescriptor,sr=Object.getOwnPropertyNames,ir=Object.getPrototypeOf,ar=Object.prototype.hasOwnProperty,cr=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ur=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})},Q=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of sr(t))!ar.call(e,o)&&o!==r&&J(e,o,{get:()=>t[o],enumerable:!(n=or(t,o))||n.enumerable});return e},lr=(e,t,r)=>(Q(e,t,"default"),r&&Q(r,t,"default")),ge=(e,t,r)=>(r=e!=null?nr(ir(e)):{},Q(t||!e||!e.__esModule?J(r,"default",{value:e,enumerable:!0}):r,e)),ve=cr((e,t)=>{"use strict";t.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}}),we={};ur(we,{default:()=>be});var fr=ge(ve());lr(we,ge(ve()));var{default:ye,...pr}=fr,be=ye!==void 0?ye:pr;function dr(){let e,t,r=new Promise((...n)=>[e,t]=n);return Object.freeze({resolve:e,reject:t,promise:r})}function xe(e,t){let r=[],n=[],o=e((...u)=>{let f=n.shift();f?f.resolve({value:u,done:!1}):r.push(u)}),s=t?.signal,i=!1,c=null,l=()=>{o?.()},p=()=>{s?.removeEventListener("abort",l),c=new Error("Abort Error")};return s?.addEventListener("abort",p,{once:!0}),{async next(){let u=r.shift();if(u)return{value:u,done:!1};if(i)return{value:void 0,done:!0};if(c)return Promise.reject(c);let f=dr();return n.push(f),f.promise},async return(){i=!0,l();for(let u of n)u.resolve({value:void 0,done:!0});return{value:void 0,done:!0}},async throw(u){return c=u,l(),{value:void 0,done:!0}},[Symbol.asyncIterator](){return this}}}var E=class extends j{},Pe=class extends j{constructor(e,t,r,n){super(e,n),this.contentType=t,this.data=r}},Se=class extends j{constructor(e,t){super(e.message,t),this.statusCode=e.statusCode,this.message=e.message,this.description=e.description,this.additionalProperties=e.additionalProperties,this.details=e.details}};var Ae=class extends j{};function je(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]]);return r}function b(e,t,r,n){function o(s){return s instanceof r?s:new r(function(i){i(s)})}return new(r||(r=Promise))(function(s,i){function c(u){try{p(n.next(u))}catch(f){i(f)}}function l(u){try{p(n.throw(u))}catch(f){i(f)}}function p(u){u.done?s(u.value):o(u.value).then(c,l)}p((n=n.apply(e,t||[])).next())})}function _e(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(e){return this instanceof m?(this.v=e,this):new m(e)}function z(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),o,s=[];return o={},i("next"),i("throw"),i("return"),o[Symbol.asyncIterator]=function(){return this},o;function i(d){n[d]&&(o[d]=function(v){return new Promise(function(O,M){s.push([d,v,O,M])>1||c(d,v)})})}function c(d,v){try{l(n[d](v))}catch(O){f(s[0][3],O)}}function l(d){d.value instanceof m?Promise.resolve(d.value.v).then(p,u):f(s[0][2],d)}function p(d){c("next",d)}function u(d){c("throw",d)}function f(d,v){d(v),s.shift(),s.length&&c(s[0][0],s[0][1])}}function K(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof _e=="function"?_e(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(s){r[s]=e[s]&&function(i){return new Promise(function(c,l){i=e[s](i),o(c,l,i.done,i.value)})}}function o(s,i,c,l){Promise.resolve(l).then(function(p){s({value:p,done:c})},i)}}var Ee=e=>new Promise(t=>setTimeout(()=>t(),e));function mr(){}var hr=class extends j{constructor(e,t){super(`Maximum number of attempts reached: ${e}`,t)}},Yo=class{constructor(e={}){this.props=e,this.attempts=0}sleep(){return b(this,void 0,void 0,function*(){if(this.attempts>=this.maxAttempts)throw new hr(this.attempts);yield Ee(this.getTimeout()),this.attempts++})}clear(){this.attempts=0}get factor(){var e;return(e=this.props.factor)!==null&&e!==void 0?e:1e3}get base(){var e;return(e=this.props.base)!==null&&e!==void 0?e:2}get maxAttempts(){var e;return(e=this.props.maxAttempts)!==null&&e!==void 0?e:Number.POSITIVE_INFINITY}getTimeout(){return this.factor*Math.pow(this.base,this.attempts)}values(){return z(this,arguments,function*(){for(;this.attempts<this.maxAttempts;)yield yield m(this.sleep())})}[Symbol.asyncIterator](){return this.values()}};var yr=e=>{let t=new Map;for(let r of e.split(",")){let n=r.match(/<([^>]+)>;\s*rel="([^"]+)"/);n&&t.set(n[2],n[1])}return t},gr=class Z{constructor(t,r,n,o,s="next"){this.http=t,this.nextPath=r,this.nextParams=n,this.meta=o,this.direction=s}next(){return b(this,void 0,void 0,function*(){if(this.nextPath==null)return{done:!0,value:void 0};let t=yield this.http.request(Object.assign({method:"GET",path:this.nextPath,search:this.nextParams},this.meta)),r=this.getLink(t.headers.get("link"));return this.nextPath=r?.pathname,this.nextParams=r?.search.replace(/^\?/,""),{done:!1,value:yield t.data}})}return(t){return b(this,void 0,void 0,function*(){return this.clear(),{done:!0,value:yield t}})}throw(t){return b(this,void 0,void 0,function*(){throw this.clear(),t})}then(t=Promise.resolve.bind(Promise),r=Promise.reject.bind(Promise)){return this.next().then(n=>t(n.value),r)}values(){return this[Symbol.asyncIterator]()}getDirection(){return this.direction}setDirection(t){return new Z(this.http,this.nextPath,this.nextParams,this.meta,t)}[Symbol.asyncIterator](){return this}getLink(t){if(t==null)return;let r=yr(t).get(this.direction);if(r!=null)return new URL(r)}clear(){this.nextPath=void 0,this.nextParams=void 0}clone(){return new Z(this.http,this.nextPath,this.nextParams,this.meta,this.direction)}},vr=class{constructor(e,t={}){this.http=e,this.params=t,this.waitForMediaAttachment=r=>b(this,void 0,void 0,function*(){let n,o=AbortSignal.timeout(this.mediaTimeout);for(;n==null;){if(o.aborted)throw new Ae(`Media processing timed out of ${this.mediaTimeout}ms`);try{yield Ee(1e3);let s=yield this.http.get(`/api/v1/media/${r}`);s.url!=null&&(n=s)}catch(s){if(s instanceof Se&&s.statusCode===404)continue;throw s}}return n})}dispatch(e){let t=this.toPrimitiveAction(e.type),r=this.isPrimitiveAction(e.type)?e.path:e.path+"/"+$(e.type),n=this.inferEncoding(t,r),o=Object.assign(Object.assign({},e.meta),{encoding:n});switch(t){case"fetch":return this.http.get(r,e.data,o);case"create":return r==="/api/v2/media"?this.http.post(r,e.data,o).then(s=>this.waitForMediaAttachment(s.id)):this.http.post(r,e.data,o);case"update":return this.http.patch(r,e.data,o);case"remove":return this.http.delete(r,e.data,o);case"list":return new gr(this.http,r,e.data)}}isPrimitiveAction(e){switch(e){case"fetch":case"create":case"update":case"remove":case"list":return!0;default:return!1}}toPrimitiveAction(e){if(this.isPrimitiveAction(e))return e;switch(e){case"lookup":case"verify_credentials":return"fetch";case"update_credentials":return"update";default:return"create"}}inferEncoding(e,t){return e==="create"&&t==="/api/v1/accounts"||e==="update"&&t==="/api/v1/accounts/update_credentials"||e==="create"&&t==="/api/v1/email"||e==="create"&&t==="/api/v1/featured_tag"||e==="create"&&t==="/api/v1/media"||e==="create"&&t==="/api/v2/media"?"multipart-form":"json"}get mediaTimeout(){var e;return(e=this.params.mediaTimeout)!==null&&e!==void 0?e:60*1e3}};function wr(e){return z(this,arguments,function*(){var t,r,n,o;let s=f=>b(this,void 0,void 0,function*(){if(c.return==null)throw new E("events.return is undefined");yield c.return(f)}),i=f=>b(this,void 0,void 0,function*(){if(c.return==null)throw new E("events.return is undefined");yield c.return(f)}),c=xe(f=>(e.addEventListener("message",f),e.addEventListener("error",i),e.addEventListener("close",s),()=>{e.removeEventListener("message",f),e.removeEventListener("error",i),e.removeEventListener("close",s)}));try{for(var l=!0,p=K(c),u;u=yield m(p.next()),t=u.done,!t;l=!0){o=u.value,l=!1;let[f]=o;yield yield m(f)}}catch(f){r={error:f}}finally{try{!l&&!t&&(n=p.return)&&(yield m(n.call(p)))}finally{if(r)throw r.error}}})}var Ho=class{constructor(e,t,r,n,o){this.connector=e,this.serializer=t,this.stream=r,this.logger=n,this.params=o}values(){var e,t,r;return z(this,arguments,function*(){var n,o,s,i;for((e=this.logger)===null||e===void 0||e.info("Subscribing to stream",this.stream);this.connector.canAcquire();){this.connection=yield m(this.connector.acquire());let u=wr(this.connection),f=this.serializer.serialize("json",Object.assign({type:"subscribe",stream:this.stream},this.params));(t=this.logger)===null||t===void 0||t.debug("\u2191 WEBSOCKET",f),this.connection.send(f);try{for(var c=!0,l=(o=void 0,K(this.transformIntoEvents(u))),p;p=yield m(l.next()),n=p.done,!n;c=!0){i=p.value,c=!1;let d=i;this.matches(d)&&((r=this.logger)===null||r===void 0||r.debug("\u2193 WEBSOCKET",d),yield yield m(d))}}catch(d){o={error:d}}finally{try{!c&&!n&&(s=l.return)&&(yield m(s.call(l)))}finally{if(o)throw o.error}}}})}unsubscribe(){if(this.connection==null)return;let e=this.serializer.serialize("json",Object.assign({type:"unsubscribe",stream:this.stream},this.params));this.connection.send(e)}[Symbol.asyncIterator](){return this.values()}matches(e){var t;let r=(t=this.params)!==null&&t!==void 0?t:{},n=Object.values(r);return[this.stream,...n].every(o=>e.stream.includes(o))}transformIntoEvents(e){return z(this,arguments,function*(){var t,r,n,o;try{for(var s=!0,i=K(e),c;c=yield m(i.next()),t=c.done,!t;s=!0){o=c.value,s=!1;let l=o,p=yield m(this.parseMessage(l.data));yield yield m(p)}}catch(l){r={error:l}}finally{try{!s&&!t&&(n=i.return)&&(yield m(n.call(i)))}finally{if(r)throw r.error}}})}parseMessage(e){return b(this,void 0,void 0,function*(){let t=this.serializer.deserialize("json",e);if("error"in t)throw new E(t.error);let r=t.event==="delete"||t.payload==null?t.payload:this.serializer.deserialize("json",t.payload);return{stream:t.stream,event:t.event,payload:r}})}};var q=(e,t=[])=>new Proxy(mr,{get:xr(e,t),apply:Pr(e,t)}),br=new Set(["then","catch","finally","inspect","toString","valueOf","toJSON","constructor","prototype","length","name","caller","callee","arguments","bind","apply","call"]),xr=(e,t)=>(r,n)=>{if(!(typeof n=="string"&&br.has(n))&&typeof n!="symbol")return n==="$select"?q(e,[...t,n]):q(e,[...t,$(n)])},Pr=(e,t)=>(r,n,o)=>{let s=t.pop();if(s==null)throw new Error("No action specified");if(s==="$select")return q(e,[...t,...o]);let i="/"+t.join("/"),[c,l]=o;return e.dispatch({type:s,path:i,data:c,meta:l})},_r=e=>{let t=new AbortController;for(let r of e)r.addEventListener("abort",()=>t.abort(),{once:!0});return t.signal},Tr=([e,...t])=>{let r=new Headers(e);for(let n of t)for(let[o,s]of new Headers(n).entries())r.set(o,s);return r},Or=1e3*300,Sr=class{constructor(e,t){this.props=e,this.serializer=t}mergeRequestInitWithDefaults(e={}){let t=Object.assign({},this.props.requestInit);{let{headers:r,signal:n}=e,o=je(e,["headers","signal"]);Object.assign(t,o),t.headers=this.mergeHeadersWithDefaults(r),t.signal=this.mergeAbortSignalWithDefaults(n)}return t}resolvePath(e,t){let r=new URL(e,this.props.url);return typeof t=="string"?r.search=t:t!=null&&(r.search=this.serializer.serialize("querystring",t)),r}createTimeout(){var e;return AbortSignal.timeout((e=this.props.timeout)!==null&&e!==void 0?e:Or)}mergeHeadersWithDefaults(e={}){var t,r;let n=Tr([(r=(t=this.props.requestInit)===null||t===void 0?void 0:t.headers)!==null&&r!==void 0?r:{},e]),o=new Headers(n);return this.props.accessToken&&o.set("Authorization",`Bearer ${this.props.accessToken}`),new Headers(o)}mergeAbortSignalWithDefaults(e){var t;let r=[this.createTimeout()];return!((t=this.props.requestInit)===null||t===void 0)&&t.signal&&r.push(this.props.requestInit.signal),e!=null&&r.push(e),_r(r)}};var Ar=class{get(e,t,r={}){return this.request(Object.assign({method:"GET",path:e,search:t},r)).then(n=>n.data)}post(e,t,r={}){return this.request(Object.assign({method:"POST",path:e,body:t},r)).then(n=>n.data)}delete(e,t,r={}){return this.request(Object.assign({method:"DELETE",path:e,body:t},r)).then(n=>n.data)}put(e,t,r={}){return this.request(Object.assign({method:"PUT",path:e,body:t},r)).then(n=>n.data)}patch(e,t,r={}){return this.request(Object.assign({method:"PATCH",path:e,body:t},r)).then(n=>n.data)}},Te=e=>{var t;let r=(t=e.get("Content-Type"))===null||t===void 0?void 0:t.replace(/\s*;.*$/,"");if(typeof r=="string")switch(r){case"application/json":return"json";case"multipart/form-data":return"multipart-form";default:return}},jr=class extends Ar{constructor(e,t,r){super(),this.serializer=e,this.config=t,this.logger=r}request(e){var t,r,n,o,s;return b(this,void 0,void 0,function*(){let i=this.createRequest(e);try{(t=this.logger)===null||t===void 0||t.info(`\u2191 ${i.method} ${i.url}`),(r=this.logger)===null||r===void 0||r.debug("	body",{encoding:e.encoding,body:e.body});let c=yield fetch(i);if(!c.ok)throw c;let l=yield c.text(),p=Te(c.headers);if(p==null)throw new E("The server returned data with an unknown encoding.");let u=this.serializer.deserialize(p,l);return(n=this.logger)===null||n===void 0||n.info(`\u2193 ${i.method} ${i.url}`),(o=this.logger)===null||o===void 0||o.debug("	body",l),{headers:c.headers,data:u}}catch(c){throw(s=this.logger)===null||s===void 0||s.debug("HTTP failed",c),yield this.createError(c)}})}createRequest(e){let{method:t,path:r,search:n,encoding:o="json",requestInit:s={}}=e,i=this.config.resolvePath(r,n),c=this.serializer.serialize(o,e.body),l=this.config.mergeRequestInitWithDefaults(s),p=new Request(i,Object.assign({method:t,body:c},l));return typeof c=="string"&&o==="json"&&p.headers.set("Content-Type","application/json"),p}createError(e){return b(this,void 0,void 0,function*(){if(e instanceof Response){let t=Te(e.headers);if(t==null)throw new E("The server returned data with an unknown encoding. The server may be down.");let r=this.serializer.deserialize(t,yield e.text()),{error:n,errorDescription:o,details:s}=r,i=je(r,["error","errorDescription","details"]);return new Se({statusCode:e.status,message:n,description:o,details:s,additionalProperties:i},{cause:e})}return e!=null&&e.name==="AbortError"?new Ae("Request timed out",{cause:e}):e})}},Er=class{constructor(e){this.logLevel=e}debug(e,t){this.logLevel.satisfies("debug")&&this.log("debug",e,t)}info(e,t){this.logLevel.satisfies("info")&&this.log("info",e,t)}warn(e,t){this.logLevel.satisfies("warn")&&this.log("warn",e,t)}error(e,t){this.logLevel.satisfies("error")&&this.log("error",e,t)}},Cr=class extends Er{log(e,t,r){let n=r==null?[t]:[t,r];switch(e){case"debug":{console.debug(...n);return}case"info":{console.info(...n);return}case"warn":{console.warn(...n);return}case"error":{console.error(...n);return}}}},y=Object.freeze({DEBUG:1,INFO:2,WARN:4,ERROR:8}),kr=class k{constructor(t){this.level=t}satisfies(t){switch(t){case"debug":return!!(this.level&y.DEBUG);case"info":return!!(this.level&y.INFO);case"warn":return!!(this.level&y.WARN);case"error":return!!(this.level&y.ERROR)}}static from(t){switch(t){case"debug":return new k(y.DEBUG|y.INFO|y.WARN|y.ERROR);case"info":return new k(y.INFO|y.WARN|y.ERROR);case"warn":return new k(y.WARN|y.ERROR);case"error":return new k(y.ERROR)}}},Mr=e=>{let t=kr.from(e??"warn");return new Cr(t)},re=e=>typeof e=="object"&&e!==null&&e.constructor.name==="Object",X=(e,t="")=>Array.isArray(e)?e.map((r,n)=>X(r,t==""?n.toString():`${t}[${n}]`)).reduce((r,n)=>Object.assign(r,n),{}):re(e)?Object.entries(e).map(([r,n])=>X(n,t===""?r:`${t}[${r}]`)).reduce((r,n)=>Object.assign(r,n),{}):t===""?e:{[t]:e},ee=(e,t="")=>Array.isArray(e)?e.flatMap((r,n)=>ee(r,t==""?n.toString():`${t}[]`)):re(e)?Object.entries(e).flatMap(([r,n])=>ee(n,t===""?r:`${t}[${r}]`)):[[t,e]],Ir=e=>ee(e).filter(([,t])=>t!=null).map(([t,r])=>`${t}=${encodeURIComponent(r)}`).join("&"),Rr={stringify:Ir},te=(e,t)=>Array.isArray(e)?e.map(r=>te(r,t)):re(e)?Object.fromEntries(Object.entries(e).map(([r,n])=>[t(r),te(n,t)])):e,Oe=(e,t)=>te(e,r=>r.includes(":")||r.startsWith("_")?r:t(r)),Fr=class{serialize(e,t){let r=Oe(t,$);switch(e){case"json":return JSON.stringify(r);case"multipart-form":{let n=new FormData;for(let[o,s]of Object.entries(X(r)))n.append(o,s);return n}case"querystring":return Rr.stringify(r);default:throw new E(`Unknown content type ${e} to serialize.`)}}deserialize(e,t){switch(e){case"json":try{return Oe(JSON.parse(t),he)}catch{throw new Pe(`Malformed JSON ${t} returned from the server.`,e,t)}default:throw new Pe(`Unknown content type ${e} returned from the server.`,e,t)}}},Ce=e=>{let t=new Fr,r=new Sr(e,t),n=Mr(e.log),o=new jr(t,r,n),s=new vr(o);return q(s,["api"])};var Dr=Object.freeze({__proto__:null}),Nr=Object.freeze({__proto__:null,Admin:Dr}),$r=Object.freeze({__proto__:null}),zr=Object.freeze({__proto__:null}),qr=Object.freeze({__proto__:null}),Lr=Object.freeze({__proto__:null,v1:zr,v2:qr}),Ur=Object.freeze({__proto__:null}),Wr=Object.freeze({__proto__:null}),Vo=Object.freeze({__proto__:null,oauth:Wr,rest:Lr,streaming:Ur,v1:Nr,v2:$r});async function ke(e){let r=(await F("mastodon",{})).accounts[e]?.url;if(!r)throw new Error(`Mastodon server URL is not configured for ${e}.`);let o=(await ue("mastodon"))[e];if(!o)throw new Error(`Mastodon access token is not configured for ${e}.`);return Ce({url:r,accessToken:o})}async function Br(e,t){let r=await ke(e);console.log("Fetching profile info");let n=await r.v1.accounts.verifyCredentials();console.log("Fetching recent statuses");let o=await r.v1.accounts.$select(n.id).statuses.list({limit:5,excludeReblogs:!0,excludeReplies:!0});console.log("Writing statuses to space");for(let s of o)await w.writePage(`${t}/${e}/${s.id}`,`---
$share: 
- "mastodon:${e}:${s.id}"
url: ${s.url}
createdAt: "${s.createdAt}"
editedAt: "${s.editedAt}"
inReplyToId: "${s.inReplyToId}"
repliesCount: ${s.repliesCount}
reblogsCount: ${s.reblogsCount}
favouritesCount: ${s.favouritesCount}
pinned: ${s.pinned}
---
${Gr(s.content)}
`)}function Gr(e){return e.replace(/<[^>]*>?/gm,"").trim()}async function Me(){let e=await F("mastodon",{}),t=await w.listPages(),r=e.pagePrefix??"mastodon";for(let n of t)n.name.startsWith(r)&&await w.deletePage(n.name);await x.flashNotification("Done cleaning!")}async function Ie(){let e=await F("mastodon",{});await x.flashNotification("Pulling statuses...");for(let t in e.accounts)await Br(t,e.pagePrefix??"mastodon");await x.flashNotification("Done!")}async function Re(e){let t=await w.readPage(e.name),r=await _.parseMarkdown(t),[n,o,s]=e.uri.split(":"),i=await le(r,[],!0);console.log("Frontmatter",i);let c=await ke(o),l=A(r),p=await c.v1.statuses.$select(s).update({status:l});return i={...i,editedAt:p.editedAt},r=await _.parseMarkdown(t),await x.dispatch(await fe(r,i)),!0}var Fe={pullAllStatusesCommand:Ie,cleanAllStatusesCommand:Me,updateToot:Re},Yr={name:"mastodon",requiredPermissions:["fetch"],functions:{pullAllStatusesCommand:{path:"mastodon.ts:pullAllStatusesCommand",command:{name:"Mastodon: Pull All Statuses"}},cleanAllStatusesCommand:{path:"mastodon.ts:cleanAllStatusesCommand",command:{name:"Mastodon: Clean All Statuses"}},updateToot:{path:"mastodon.ts:updateToot",events:["share:mastodon"]}},assets:{}};se(Fe,Yr);return qe(Hr);})();
